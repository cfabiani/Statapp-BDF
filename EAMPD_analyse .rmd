---
editor_options: 
  markdown: 
    wrap: 72
---
```{r}
library("readxl") 
library("here") 
install.packages(c("FactoMineR","factoextra")) library("FactoMineR") 
library("factoextra")
library("lubridate") 
library("dplyr") 
library("tidyverse")
library("ggplot2") 
install.packages("psych") 
library("psych")
```

```{r}
# Chargement des bases de données

press_release<- read_excel(here("Dataset_EA-MPD.xlsx"), sheet = "Press Release Window") 
press_conference<-read_excel(here("Dataset_EA-MPD.xlsx"), sheet = "Press Conference Window") 
monetary_event<- read_excel(here("Dataset_EA-MPD.xlsx"), sheet = "Monetary Event Window")

```


```{r}
# Création de variables de dates utilisables 
monetary_event["date"]<-ymd(monetary_event$date) 
monetary_event["year"] <- year(monetary_event$date)
monetary_event["month"] <-month(monetary_event$date) 
monetary_event["day"] <- day(monetary_event$date)

press_release["date"]<-ymd(press_release$date) 
press_release["year"] <- year(press_release$date)
press_release["month"] <-month(press_release$date) 
press_release["day"] <- day(press_release$date)

press_conference["date"]<-ymd(press_conference$date) 
press_conference["year"] <- year(press_conference$date)
press_conference["month"] <-month(press_conference$date) 
press_conference["day"] <- day(press_conference$date)

```

```{r}
# Bases de données 

monetary_event_2009<- monetary_event %>% filter(year>= 2009)
monetary_event_2020=monetary_event%>%filter(year>=2020)
monetary_event_2016=monetary_event%>%filter(year>=2016)

press_release_2020=press_release%>%filter(year>=2020)
press_conference_2020=press_conference%>%filter(year>=2020)
```


```{r}
monetary_event_2009$date=format(press_conference_2009$date, "%Y-%m-%d")

# Création d'un vecteur avec toutes les dates
date=monetary_event_2009$date 

monetary_event_work<-monetary_event_2009[2:15] monetary_event_work=t(monetary_event_work)
colnames(monetary_event_work)=date
```

```{r}
# Réalisation de l'ACP
PC.pca<-PCA(monetary_event_work, scale.unit = TRUE, graph = FALSE)
#print(PC.pca) 
eig.val<- get_eigenvalue(PC.pca) 
#print(eig.val)
fviz_eig(PC.pca, addlabels = TRUE, ylim = c(0, 60))
var<- get_pca_var(PC.pca) fviz_pca_var(PC.pca, col.var = "black")

```

```{r}
# Contributions des OIS à chacune des composantes de l'ACP

ind=get_pca_ind(PC.pca) 
fviz_pca_ind(PC.pca, repel=TRUE)
fviz_contrib(PC.pca, choice = "ind", axes = 1) 
fviz_contrib(PC.pca, choice = "ind", axes = 2)
```

```{r}
# Evolution temporelle des annonces de taux 1
ggplot(monetary_event_2020, aes(x=date))+ 
geom_line(aes(y = OIS_1M,color = "OIS_1M"))+ geom_line(aes(y = OIS_1Y, color = "OIS_1Y"))+
geom_line(aes(y = OIS_10Y, color = "OIS_10Y"))+ 
labs(x = "Date des annonces monétaires", y = "Variation du taux des instruments")+
scale_color_manual(values = c(OIS_1M = "coral4", OIS_1Y = "dimgray", OIS_10Y = "greenyellow"), labels = c("OIS_SW", "OIS_1M", "OIS_1Y"), name= "Instrument") + 
theme_bw()+ 
ggtitle("Evolution temporelle des variations surprise des taux")
```

```{r}
# Evolution temporelle des annonces de taux 2
graph_data=data.frame(press_release_2020$date,press_release_2020$OIS_1M,press_conference_2020$OIS_1M,monetary_event_2020$OIS_1M)
colnames(graph_data)=c("date","press_release","press_conference","monetary_event")

ggplot(graph_data, aes(x=date))+
  geom_line(aes(y = press_release,color = "press_release"))+ 
  geom_line(aes(y = press_conference, color = "press_conference"))+
  geom_line(aes(y = monetary_event, color = "monetary_event"))+
  scale_color_manual(values = c(press_release = "blue", press_conference = "red", monetary_event= "yellow"), labels = c("monetary_event", "press_conference", "press_release"), name= "Window")+
  labs(x = "Date des annonces monétaires", y = "Variation du taux des OIS 1M")+
  theme_bw()+
  ggtitle("Evolution temporelle des variations surprise des taux dans chaque fenêtre")
```


```{r}
# Autre méthode  
monetary_event_work2 =scale(monetary_event_work) 
PC.pca_2<- prcomp(monetary_event_work2)
```

```{r}
# Tentative de rotation 1
head(var$coord, 4) 
loadings_matrix=var$contrib[,1:2] 
F1=var$coord[, 1] 
F2 <- var$coord[, 2] 
F <- cbind(F1, F2)
```

```{r}
# Tentative de rotation 2

# On veut récupérer le vecteur Z tel que Z=FU où U est la matrice de rotation adaptée.Pour construire U on se réfère à "The impact of ECB monetary policy decisions and communication on the yield curve"

gamma1=loadings_matrix[2,1] 
gamma2=loadings_matrix[2,2]
alpha1=gamma1/(gamma1+gamma2) 
alpha2=gamma2/(gamma1+gamma2)
beta1=-alpha2*var(F2)/(alpha1*var(F1)-alpha2*var(F2))
beta2=alpha1*var(F1)/(alpha1*var(F1)-alpha2*var(F2))

# ATTENTION : il faut avant standardiser les colonnes de U

U=cbind(c(alpha1,alpha2),c(beta1,beta2))

z1=alpha1*F1+alpha2*F2 
z2=beta1*F1+beta2*F2

Z=cbind(date,z1,z2)
```

```{r}
# Tentative de rotation 3

# Matrice de rotation d'après mes calculs à la main
gamma=sqrt(gamma1^2+gamma2^2) 
a=gamma1/gamma 
b=gamma2/gamma 
c=-b 
d=a
U_main=cbind(c(a,b),c(c,d)) 
z1_main=a*F1+b*F2 
z2_main=c*F1+d*F2
Z_main=cbind(date,z1_main,z2_main)

df_final=merge(press_conference_2009, Z_main, by="date")
df_final2=merge(press_conference_2009, Z, by="date")
```

```{r}
# Scaling
# Selon l'article "Measuring Euro Area Monetary Policy", on pondère les vecteurs trouvés, pour que une augmentation de un point de z1 soit associée à une augmentation de 1% du 1 month OIS  et qu'une augmentation de un point de z2 soit associée à une augmentation de 1% du 2 year OIS.

scaling_vector1=press_conference_2009$OIS_1M 
scaling_vector2=press_conference_2009$OIS_2Y

reg=lm(OIS_1M~z1_main, data=df_final)

summary(reg)
```

```{r}
plot1=ggplot(df_final, aes(x = z1_main, y = OIS_1M))+
  geom_point()

plot2=ggplot(df_final2, aes(x = z1, y = OIS_1M))+
  geom_point(color='blue')

```

